version: "3.9"
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ua
      POSTGRES_PASSWORD: ua
      POSTGRES_DB: ua
    volumes:
      - ua_pg:/var/lib/postgresql/data
  backend:
    image: ghcr.io/unifiedattestation/backend:latest
    environment:
      DATABASE_URL: postgresql://ua:ua@postgres:5432/ua
      PORT: 3001
      UA_CONFIG_PATH: /app/config.yaml
    depends_on:
      - postgres
    volumes:
      - ./config.yaml:/app/config.yaml:ro
  portal:
    image: ghcr.io/unifiedattestation/portal:latest
    depends_on:
      - backend
  caddy:
    image: caddy:2-alpine
    depends_on:
      - portal
      - backend
    ports:
      - "3000:3000"
    command: ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
    configs:
      - source: caddyfile
        target: /etc/caddy/Caddyfile
volumes:
  ua_pg:
configs:
  caddyfile:
    content: |
      :3000 {
        handle /api/* {
          reverse_proxy backend:3001
        }

        reverse_proxy portal:3000
      }
