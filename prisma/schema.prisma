generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  app_dev
  oem
  admin
}

enum FederationStatus {
  active
  disabled
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole
  disabledAt   DateTime?
  displayName  String?
  createdAt    DateTime @default(now())
  apps         App[]
  oemOrg       OemOrg? @relation("OemOrgMembers", fields: [oemOrgId], references: [id])
  oemOrgId     String?
  ownedOemOrg  OemOrg? @relation("OemOrgOwner")
  auditLogs    AuditLog[]
}

model App {
  id                 String   @id @default(cuid())
  projectId          String   @unique
  name               String
  packageName        String
  signerDigestSha256 String
  apiSecretHash      String
  apiSecretPrefix    String
  createdAt          DateTime @default(now())
  ownerUserId        String
  ownerUser          User     @relation(fields: [ownerUserId], references: [id])
  reports            DeviceReport[]
}

model DeviceReport {
  id              String   @id @default(cuid())
  appId           String?
  projectId       String
  scopedDeviceId  String
  issuerBackendId String
  deviceFamilyId  String?
  buildPolicyId   String?
  buildPolicyName String?
  lastSeen        DateTime
  lastVerdict     Json
  lastState       Json
  app             App?     @relation(fields: [appId], references: [id])
  deviceFamily    DeviceFamily? @relation(fields: [deviceFamilyId], references: [id])
  buildPolicy     BuildPolicy? @relation(fields: [buildPolicyId], references: [id])

  @@unique([projectId, scopedDeviceId], name: "projectId_scopedDeviceId")
}

model OemOrg {
  id           String   @id @default(cuid())
  name         String
  ownerUserId  String   @unique
  ownerUser    User     @relation("OemOrgOwner", fields: [ownerUserId], references: [id])
  manufacturer String?
  brand        String?
  rsaRootCertPem String?
  rsaRootKeyPem  String?
  ecdsaRootCertPem String?
  ecdsaRootKeyPem  String?
  createdAt    DateTime @default(now())
  users        User[]   @relation("OemOrgMembers")
  deviceFamilies DeviceFamily[]
  deviceEntries DeviceEntry[]
  attestationRoots AttestationRoot[]
}

model DeviceFamily {
  id                  String   @id @default(cuid())
  oemOrgId            String
  name                String
  codename            String?
  model               String?
  manufacturer        String?
  brand               String?
  enabled             Boolean  @default(true)
  createdAt           DateTime @default(now())
  oemOrg              OemOrg   @relation(fields: [oemOrgId], references: [id])
  buildPolicies       BuildPolicy[]
  reports             DeviceReport[]
  deviceEntries       DeviceEntry[]
}

model AttestationAuthority {
  id        String   @id @default(cuid())
  name      String
  baseUrl   String
  enabled   Boolean  @default(true)
  isLocal   Boolean  @default(false)
  createdAt DateTime @default(now())
  roots     AttestationRoot[]
  status    AttestationStatusCache?
  devices   DeviceEntry[]
}

model AttestationRoot {
  id           String   @id @default(cuid())
  authorityId  String
  oemOrgId     String?
  name         String?
  pem          String
  createdAt    DateTime @default(now())
  authority    AttestationAuthority @relation(fields: [authorityId], references: [id])
  oemOrg       OemOrg? @relation(fields: [oemOrgId], references: [id])
  rsaDeviceEntries DeviceEntry[] @relation("DeviceRsaRoot")
  ecdsaDeviceEntries DeviceEntry[] @relation("DeviceEcdsaRoot")
}

model AttestationStatusCache {
  id           String   @id @default(cuid())
  authorityId  String   @unique
  revokedSerials Json
  suspendedSerials Json
  fetchedAt    DateTime @default(now())
  authority    AttestationAuthority @relation(fields: [authorityId], references: [id])
}

model DeviceEntry {
  id           String   @id @default(cuid())
  authorityId  String
  oemOrgId     String
  deviceFamilyId String
  deviceId     String?
  rsaSerialHex   String   @unique
  ecdsaSerialHex String   @unique
  rsaRootId     String
  ecdsaRootId   String
  revokedAt    DateTime?
  createdAt    DateTime @default(now())
  authority    AttestationAuthority @relation(fields: [authorityId], references: [id])
  rsaRoot       AttestationRoot @relation("DeviceRsaRoot", fields: [rsaRootId], references: [id])
  ecdsaRoot     AttestationRoot @relation("DeviceEcdsaRoot", fields: [ecdsaRootId], references: [id])
  oemOrg       OemOrg @relation(fields: [oemOrgId], references: [id])
  deviceFamily DeviceFamily @relation(fields: [deviceFamilyId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  action      String
  details     Json
  createdAt   DateTime @default(now())
  actor       User     @relation(fields: [actorUserId], references: [id])
}

model BuildPolicy {
  id                      String   @id @default(cuid())
  deviceFamilyId          String
  name                    String
  verifiedBootKeyHex      String
  verifiedBootHashHex     String?
  osVersionRaw            Int?
  minOsPatchLevelRaw      Int?
  enabled                 Boolean @default(true)
  createdAt               DateTime @default(now())
  deviceFamily            DeviceFamily @relation(fields: [deviceFamilyId], references: [id])
  reports                 DeviceReport[]
}

model FederationBackend {
  id         String   @id @default(cuid())
  backendId  String   @unique
  name       String
  url        String?
  publicKeys Json
  status     FederationStatus
  createdAt  DateTime @default(now())
}
